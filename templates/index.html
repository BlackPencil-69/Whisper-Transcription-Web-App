<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { text-align: center; color: #333; margin-bottom: 10px; font-size: 28px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .upload-area {
            border: 3px dashed #667eea; border-radius: 12px; padding: 60px 20px;
            text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 20px;
            background: #f8f9ff;
        }
        .upload-area.dragover { background: #e8eaff; border-color: #764ba2; }
        .upload-icon { font-size: 48px; margin-bottom: 10px; }
        .upload-text { color: #667eea; font-size: 16px; font-weight: 500; }
        .file-input { display: none; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .option-group { display: flex; flex-direction: column; }
        label { font-size: 14px; color: #555; margin-bottom: 5px; font-weight: 500; }
        select {
            padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;
            cursor: pointer; transition: border-color 0.3s;
        }
        select:focus { outline: none; border-color: #667eea; }
        .btn {
            width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: transform 0.2s;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .progress-section { display: none; margin-top: 30px; }
        .progress-bar-container { width: 100%; height: 30px; background: #f0f0f0; border-radius: 15px; overflow: hidden; margin-bottom: 10px; }
        .progress-bar {
            height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 12px; font-weight: 600;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        .progress-message { text-align: center; color: #666; font-size: 14px; }
        .result-section { display: none; margin-top: 30px; }
        .result-actions { display: flex; gap: 10px; margin-bottom: 15px; }
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .copy-btn { background: #28a745; color: white; }
        .download-btn { background: #007bff; color: white; }
        .result-text {
            background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px;
            max-height: 400px; overflow-y: auto; line-height: 1.6; font-size: 14px; color: #333; white-space: pre-wrap;
        }
        .selected-file { display: none; margin-top: 15px; padding: 12px; background: #e8f5e9; border-radius: 8px; color: #2e7d32; font-size: 14px; text-align: center; }
        .info-badge { display: inline-block; padding: 4px 12px; background: #e3f2fd; color: #1976d2; border-radius: 12px; font-size: 12px; margin-top: 10px; }
        @media (max-width: 600px) {
            .options { grid-template-columns: 1fr; }
            .result-actions { flex-direction: column; }
            h1 { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Whisper –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è</h1>
        <p class="subtitle">–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å –∞—É–¥—ñ–æ/–≤—ñ–¥–µ–æ —Ñ–∞–π–ª –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É</p>

        <div class="upload-area" id="uploadArea" tabindex="0">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">–ö–ª—ñ–∫–Ω—ñ—Ç—å –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–∞–π–ª —Å—é–¥–∏</div>
            <input type="file" id="fileInput" class="file-input" accept="audio/*,video/*">
        </div>

        <div class="selected-file" id="selectedFile"></div>

        <div class="options">
            <div class="option-group">
                <label for="language">–ú–æ–≤–∞:</label>
                <select id="language">
                    <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                    <option value="ru">–†–æ—Å—ñ–π—Å—å–∫–∞</option>
                    <option value="en">–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞</option>
                    <option value="ja">–Ø–ø–æ–Ω—Å—å–∫–∞</option>
                </select>
            </div>
            <div class="option-group">
                <label for="modelSize">–ú–æ–¥–µ–ª—å:</label>
                <select id="modelSize">
                    <option value="tiny">Tiny (—à–≤–∏–¥–∫–∞)</option>
                    <option value="base" selected>Base (–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞)</option>
                    <option value="small">Small (—Ç–æ—á–Ω–∞)</option>
                    <option value="medium">Medium (–¥—É–∂–µ —Ç–æ—á–Ω–∞)</option>
                    <option value="large">Large (–Ω–∞–π—Ç–æ—á–Ω—ñ—à–∞)</option>
                </select>
            </div>
        </div>

        <button class="btn" id="transcribeBtn" disabled>–ü–æ—á–∞—Ç–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—é</button>

        <div class="progress-section" id="progressSection" aria-hidden="true">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width:0%">0%</div>
            </div>
            <div class="progress-message" id="progressMessage">–û–±—Ä–æ–±–∫–∞...</div>
        </div>

        <div class="result-section" id="resultSection" aria-hidden="true">
            <div class="result-actions">
                <button class="action-btn copy-btn" id="copyBtn">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç</button>
                <button class="action-btn download-btn" id="downloadBtn">üíæ –°–∫–∞—á–∞—Ç–∏ —Å—É–±—Ç–∏—Ç—Ä–∏</button>
            </div>
            <div class="result-text" id="fullText"></div>
            <div id="languageInfo" class="info-badge" style="display: none;">
                –í–∏–∑–Ω–∞—á–µ–Ω–∞ –º–æ–≤–∞: <span id="detectedLanguage"></span>
            </div>
        </div>
    </div>

    <!-- ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–∏–π, —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π JavaScript -->
    <script>
    let selectedFile = null;
    let currentTaskId = null;
    let srtFilename = null;
    let progressTimer = null;

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const transcribeBtn = document.getElementById('transcribeBtn');
    const progressSection = document.getElementById('progressSection');
    const resultSection = document.getElementById('resultSection');
    const selectedFileDiv = document.getElementById('selectedFile');
    const progressBar = document.getElementById('progressBar');
    const progressMessage = document.getElementById('progressMessage');
    const fullTextEl = document.getElementById('fullText');
    const languageInfo = document.getElementById('languageInfo');
    const detectedLanguageEl = document.getElementById('detectedLanguage');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    function resetUI() {
        clearTimeout(progressTimer);
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressMessage.textContent = '';
        progressSection.style.display = 'none';
        resultSection.style.display = 'none';
        languageInfo.style.display = 'none';
        transcribeBtn.disabled = false;
        transcribeBtn.textContent = '–ü–æ—á–∞—Ç–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—é';
    }

    function showProgress(percent, message) {
        progressSection.style.display = 'block';
        progressBar.style.width = `${percent}%`;
        progressBar.textContent = `${percent}%`;
        progressMessage.textContent = message || '–û–±—Ä–æ–±–∫–∞...';
    }

    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
            selectedFile = e.target.files[0];
            selectedFileDiv.textContent = `–û–±—Ä–∞–Ω–æ: ${selectedFile.name}`;
            selectedFileDiv.style.display = 'block';
            transcribeBtn.disabled = false;
        }
    });

    uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            selectedFile = e.dataTransfer.files[0];
            fileInput.files = e.dataTransfer.files;
            selectedFileDiv.textContent = `–û–±—Ä–∞–Ω–æ: ${selectedFile.name}`;
            selectedFileDiv.style.display = 'block';
            transcribeBtn.disabled = false;
        }
    });

    transcribeBtn.addEventListener('click', async () => {
        if (!selectedFile) return alert('–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª!');
        if (selectedFile.size === 0) return alert('‚ùå –§–∞–π–ª –ø–æ—Ä–æ–∂–Ω—ñ–π!');
        if (selectedFile.size > 500 * 1024 * 1024) return alert('‚ùå –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä 500 MB.');

        resetUI();
        transcribeBtn.disabled = true;
        transcribeBtn.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
        showProgress(5, '–ü–µ—Ä–µ–¥–∞—á–∞ —Ñ–∞–π–ª—É...');

        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('language', document.getElementById('language').value);
        formData.append('model_size', document.getElementById('modelSize').value);

        try {
            const response = await fetch('/upload', { method: 'POST', body: formData });
            const data = await response.json();
            if (!response.ok || data.error) throw new Error(data.error || '–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            if (!data.task_id) throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–≤–µ—Ä–Ω—É–≤ task_id');

            currentTaskId = data.task_id;
            transcribeBtn.textContent = '–û–±—Ä–æ–±–∫–∞...';
            pollProgress();
        } catch (err) {
            alert('‚ùå ' + err.message);
            resetUI();
        }
    });

    async function pollProgress() {
        try {
            const resp = await fetch(`/progress/${encodeURIComponent(currentTaskId)}`);
            if (!resp.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É');
            const data = await resp.json();

            const p = Math.min(100, Math.max(0, +data.progress || 0));
            showProgress(p, data.message || '–û–±—Ä–æ–±–∫–∞...');

            if (data.status === 'completed') {
                displayResults(data.result);
            } else if (data.status === 'error') {
                alert('‚ùå ' + (data.message || '–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏'));
                resetUI();
            } else {
                progressTimer = setTimeout(pollProgress, 1000);
            }
        } catch (err) {
            console.warn('–ü–æ–º–∏–ª–∫–∞ –∑ º—î–¥–Ω–∞–Ω–Ω—è, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 2 —Å');
            progressTimer = setTimeout(pollProgress, 2000);
        }
    }

    function displayResults(result = {}) {
        clearTimeout(progressTimer);
        fullTextEl.textContent = result.full_text || '(–¢–µ–∫—Å—Ç –Ω–µ —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ)';
        srtFilename = result.srt_filename || null;

        if (result.detected_language) {
            detectedLanguageEl.textContent = result.detected_language;
            languageInfo.style.display = 'inline-block';
        } else {
            languageInfo.style.display = 'none';
        }

        progressSection.style.display = 'none';
        resultSection.style.display = 'block';
        transcribeBtn.disabled = false;
        transcribeBtn.textContent = '–ü–æ—á–∞—Ç–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—é';
    }

    copyBtn.addEventListener('click', async () => {
        const text = fullTextEl.textContent.trim();
        if (!text) return alert('–ù–µ–º–∞—î —Ç–µ–∫—Å—Ç—É –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è');
        try {
            await navigator.clipboard.writeText(text);
            alert('‚úÖ –¢–µ–∫—Å—Ç —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');
        } catch {
            alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç');
        }
    });

    downloadBtn.addEventListener('click', async () => {
        if (!srtFilename) return alert('–§–∞–π–ª —Å—É–±—Ç–∏—Ç—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        try {
            const resp = await fetch(`/download/${encodeURIComponent(srtFilename)}`);
            if (!resp.ok) throw new Error('–§–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = srtFilename;
            a.click();
            URL.revokeObjectURL(url);
        } catch (err) {
            alert('‚ùå ' + err.message);
        }
    });
    </script>
</body>
</html>
